{% load static %}
{% load currency_filters %}
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cửa Hàng Thẻ Bài Yu-Gi-Oh - Thẻ Bài Giao Dịch Cao Cấp</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- Custom CSS Files -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/sections.css' %}">
    <link rel="stylesheet" href="{% static 'css/utilities.css' %}">
</head>

<body>
    <!-- Navigation -->
    {% include 'includes/navbar.html' %}
    <!-- Hero Product Slider -->
    <section class="hero-slider-section" style="position: relative; margin-top: 150px;">
        <div class="container-fluid px-0">
            <div id="heroProductCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel"
                data-bs-interval="10000">

                <!-- Admin Edit Buttons - Floating Overlay -->
                {% if user.is_staff %}
                <div style="position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; gap: 10px;">
                    <a href="{% url 'admin_dashboard:hero_slider' %}" class="btn btn-warning shadow-lg"
                        style="font-weight: 600; padding: 10px 20px; border-radius: 8px;">
                        <i class="fas fa-edit me-2"></i>Thay đổi ảnh bìa
                    </a>
                    <button type="button" class="btn btn-info shadow-lg text-white" data-bs-toggle="modal"
                        data-bs-target="#manageSliderModal"
                        style="font-weight: 600; padding: 10px 20px; border-radius: 8px;">
                        <i class="fas fa-cog me-2"></i>Sửa nhanh
                    </button>
                </div>
                {% endif %}

                <div class="carousel-indicators">
                    {% for slide in hero_slides %}
                    <button type="button" data-bs-target="#heroProductCarousel"
                        data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active"
                        aria-current="true" {% endif %} aria-label="Slide {{ forloop.counter }}"></button>
                    {% endfor %}
                </div>

                <div class="carousel-inner">
                    {% for slide in hero_slides %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <div class="hero-slide-wrapper">
                            <div class="hero-slide-image" data-aos="zoom-in">
                                {% if slide.link_url %}
                                <a href="{{ slide.link_url }}" class="d-block">
                                    <img src="{{ slide.image.url }}" alt="{{ slide.title }}" class="img-fluid">
                                </a>
                                {% else %}
                                <img src="{{ slide.image.url }}" alt="{{ slide.title }}" class="img-fluid">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="carousel-item active">
                        <div class="hero-slide-wrapper">
                            <div class="hero-slide-placeholder text-center py-5">
                                <i class="fas fa-images fa-5x text-muted mb-3"></i>
                                <p class="text-muted">No slider images available</p>
                                {% if user.is_staff %}
                                <a href="{% url 'admin_dashboard:hero_slider' %}" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Add Slider Images
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <button class="carousel-control-prev" type="button" data-bs-target="#heroProductCarousel"
                    data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#heroProductCarousel"
                    data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>
    </section>
    <!-- New Arrivals Section -->
    <section class="new-arrivals-section py-5">
        <div class="container">
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h2 class="display-4 fw-bold mb-4 text-black" data-aos="fade-up">Sản phẩm mới</h2>
                </div>
            </div>
            <div class="row g-4">
                {% for card in new_arrivals %}
                <div class="col-lg-3 col-md-6" data-aos="zoom-in" data-aos-delay="{{ forloop.counter|add:100 }}">
                    <a href="{% url 'card_detail' card.pk %}" class="text-decoration-none">
                        <div class="card-showcase h-100">
                            <div class="card-image-container">
                                {% if card.image %}
                                <img src="{{ card.image.url }}" alt="{{ card.name }}" class="w-100 h-100 object-cover">
                                {% else %}
                                <div class="card-placeholder">
                                    {% if card.card_type == 'monster' %}
                                    <i class="fas fa-dragon fa-4x text-white"></i>
                                    {% elif card.card_type == 'spell' %}
                                    <i class="fas fa-magic fa-4x text-white"></i>
                                    {% else %}
                                    <i class="fas fa-shield-alt fa-4x text-white"></i>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="card-showcase-body">
                                <h5 class="fw-bold mb-2">{{ card.name }}</h5>
                                <div class="mb-3">
                                    <span class="badge bg-warning me-2">{{ card.get_rarity_display }}</span>
                                    <span class="badge bg-outline-light">{{ card.get_card_type_display }}</span>
                                </div>
                                <div class="d-flex justify-content-center align-items-center mb-2">
                                    <span class="h4 text-success mb-0">{{ card.price|format_currency }}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                {% empty %}
                <div class="col-12 text-center">
                    <p class="text-light">Không có thẻ bài mới nào hiện tại.</p>
                </div>
                {% endfor %}
            </div>
            {% if new_arrivals %}
            <div class="text-center mt-5" data-aos="fade-up">
                <a href="{% url 'card_list' %}" class="btn btn-primary btn-lg px-5">
                    <i class="fas fa-eye me-2"></i>Xem Tất Cả Thẻ Bài
                </a>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Card Sets Section -->
    <section class="card-sets-section py-5 bg-light">
        <div class="container">
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h2 class="display-4 fw-bold mb-4 text-black" data-aos="fade-up">Card Sets</h2>
                    <!-- <p class="lead text-muted" data-aos="fade-up" data-aos-delay="200">Khám phá các bộ thẻ bài Yu-Gi-Oh
                        mới nhất</p> -->
                </div>
            </div>
            <div class="row g-4">
                {% for card_set in new_card_sets %}
                <div class="col-lg-3 col-md-6" data-aos="fade-up" data-aos-delay="{{ forloop.counter|add:100 }}">
                    <div class="set-card h-100">
                        <a href="{% url 'card_list' %}?set={{ card_set.id }}" class="text-decoration-none">
                            <div class="set-image-container">
                                {% if card_set.image %}
                                <img src="{{ card_set.image.url }}" alt="{{ card_set.name }}"
                                    class="w-100 h-100 object-cover">
                                {% else %}
                                <div class="set-placeholder">
                                    <i class="fas fa-layer-group fa-4x text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="set-card-body">
                                <h5 class="fw-bold mb-2 text-dark">{{ card_set.name }}</h5>
                                <p class="text-muted small mb-3">
                                    <i class="fas fa-calendar-alt me-2"></i>{{ card_set.release_date|date:"d/m/Y" }}
                                </p>
                                {% if card_set.description %}
                                <p class="text-muted small mb-3 set-description">{{
                                    card_set.description|truncatewords:15 }}</p>
                                {% endif %}
                                <!-- <div class="d-flex justify-content-between align-items-center">
                                    <span class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-2"></i>Xem thẻ bài
                                    </span>
                                    <small class="text-muted">
                                        <i class="fas fa-box me-1"></i>{{ card_set.card_set.count }} thẻ
                                    </small>
                                </div> -->
                            </div>
                        </a>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center">
                    <p class="text-muted">Không có bộ thẻ bài nào hiện tại.</p>
                </div>
                {% endfor %}
            </div>
            {% if new_card_sets %}
            <div class="text-center mt-5" data-aos="fade-up">
                <a href="{% url 'card_list' %}" class="btn btn-primary btn-lg px-5">
                    <i class="fas fa-th-large me-2"></i>Xem Tất Cả Bộ Thẻ
                </a>
            </div>
            {% endif %}
        </div>
    </section>


    <!-- Manage Slider Modal -->
{% if user.is_staff %}
<div class="modal fade" id="manageSliderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">
                    <i class="fas fa-images me-2"></i>Quản lý Hero Slider
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Tabs -->
                <ul class="nav nav-tabs nav-fill" id="sliderTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#add-pane"
                            type="button" role="tab">
                            <i class="fas fa-plus me-2"></i>Thêm Slide Mới
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane"
                            type="button" role="tab">
                            <i class="fas fa-list me-2"></i>Danh sách Slide
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-3" id="sliderTabContent">
                    <!-- Add Tab (Active by default) -->
                    <div class="tab-pane fade show active" id="add-pane" role="tabpanel">
                        <form method="post" action="{% url 'admin_dashboard:hero_slider' %}"
                            enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="add_slide" value="1">
                            <input type="hidden" name="next" value="{% url 'home' %}">

                            <div class="mb-3">
                                <label class="form-label fw-bold">Tiêu đề *</label>
                                <input type="text" class="form-control" name="title" required
                                    placeholder="Ví dụ: Bộ sưu tập mới">
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Mô tả</label>
                                <textarea class="form-control" name="description" rows="2"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Hình ảnh *</label>
                                <input type="file" class="form-control" name="image" accept="image/*" required>
                                <small class="text-muted">Khuyên dùng: 1200x400px</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Link liên kết</label>
                                <select class="form-select mb-2" name="link_type"
                                    onchange="toggleCardSetSelect(this, 'add_card_set_container')">
                                    <option value="">-- Không liên kết --</option>
                                    <option value="all_cards">Tất cả thẻ bài</option>
                                    <option value="card_set">Bộ thẻ bài cụ thể</option>
                                    <option value="other_products">Sản phẩm khác</option>
                                </select>

                                <div id="add_card_set_container" style="display: none;">
                                    <select class="form-select" name="card_set_id">
                                        <option value="">-- Chọn bộ thẻ bài --</option>
                                        {% for card_set in all_card_sets %}
                                        <option value="{{ card_set.id }}">{{ card_set.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Thứ tự hiển thị</label>
                                <input type="number" class="form-control" name="order" value="0">
                                <small class="text-muted">Đặt là 0 để hiển thị đầu tiên</small>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus-circle me-2"></i>Thêm Slide
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="list-pane" role="tabpanel">
                        {% if hero_slides %}
                        <div class="accordion" id="slidesAccordion">
                            {% for slide in hero_slides %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ slide.id }}">
                                    <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapse{{ slide.id }}">
                                        <div class="d-flex align-items-center w-100">
                                            <img src="{{ slide.image.url }}" class="me-3 rounded"
                                                style="width: 60px; height: 30px; object-fit: cover;">
                                            <span class="fw-bold me-auto">{{ slide.title }}</span>
                                            <span
                                                class="badge {% if slide.is_active %}bg-success{% else %}bg-secondary{% endif %} me-2">
                                                {% if slide.is_active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse{{ slide.id }}" class="accordion-collapse collapse"
                                    data-bs-parent="#slidesAccordion">
                                    <div class="accordion-body bg-light">
                                        <form method="post" action="{% url 'admin_dashboard:hero_slider' %}"
                                            enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <input type="hidden" name="edit_slide" value="1">
                                            <input type="hidden" name="slide_id" value="{{ slide.id }}">
                                            <input type="hidden" name="next" value="{% url 'home' %}">

                                            <div class="row g-3">
                                                <div class="col-md-12">
                                                    <label class="form-label">Tiêu đề</label>
                                                    <input type="text" class="form-control" name="title"
                                                        value="{{ slide.title }}" required>
                                                </div>
                                                <div class="col-md-12">
                                                    <label class="form-label">Mô tả</label>
                                                    <textarea class="form-control" name="description"
                                                        rows="2">{{ slide.description }}</textarea>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Thứ tự hiển thị</label>
                                                    <input type="number" class="form-control" name="order"
                                                        value="{{ slide.order }}">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Thay đổi ảnh</label>
                                                    <input type="file" class="form-control" name="image"
                                                        accept="image/*">
                                                </div>

                                                <div class="col-md-12">
                                                    <label class="form-label">Link liên kết</label>
                                                    <select class="form-select mb-2" name="link_type"
                                                        onchange="toggleCardSetSelect(this, 'edit_card_set_{{ slide.id }}')">
                                                        <option value="">-- Không liên kết --</option>
                                                        <option value="all_cards" {% if slide.link_url == '/cards/'%}selected{% endif %}>
                                                            Tất cả thẻ bài
                                                        </option>
                                                        <option value="card_set" {% if '/cards/?set=' in slide.link_url and slide.link_url != '/cards/' %}selected{% endif %}>
                                                            Bộ thẻ bài cụ thể
                                                        </option>
                                                        <option value="other_products" {% if slide.link_url == '/other_products/' %}selected{% endif %}>
                                                            Sản phẩm khác
                                                        </option>
                                                    </select>

                                                    <div id="edit_card_set_{{ slide.id }}"
                                                        style="display: {% if '/cards/?set=' in slide.link_url and slide.link_url != '/cards/' %}block{% else %}none{% endif %};">
                                                        <select class="form-select" name="card_set_id">
                                                            <option value="">-- Chọn bộ thẻ bài --</option>
                                                            {% for card_set in all_card_sets %}
                                                            {% with expected_url='/cards/?set='|add:card_set.code %}
                                                            <option value="{{ card_set.id }}" {% if slide.link_url == expected_url %}selected{% endif %}>
                                                                {{ card_set.name }}
                                                            </option>
                                                            {% endwith %}
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="col-12 d-flex justify-content-between mt-3 pt-3 border-top">
                                                    <div>
                                                        <button type="submit" name="toggle_active"
                                                            value="{{ slide.id }}"
                                                            class="btn btn-outline-secondary btn-sm" formnovalidate>
                                                            {% if slide.is_active %}
                                                            <i class="fas fa-eye-slash me-1"></i>Ẩn
                                                            {% else %}
                                                            <i class="fas fa-eye me-1"></i>Hiện
                                                            {% endif %}
                                                        </button>
                                                        <button type="submit" name="delete_slide"
                                                            value="{{ slide.id }}"
                                                            class="btn btn-outline-danger btn-sm ms-2"
                                                            onclick="return confirm('Bạn có chắc chắn muốn xóa slide này?')"
                                                            formnovalidate>
                                                            <i class="fas fa-trash me-1"></i>Xóa
                                                        </button>
                                                    </div>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-save me-1"></i>Lưu thay đổi
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-images fa-3x mb-3"></i>
                            <p>Chưa có slide nào. Hãy thêm slide mới!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleCardSetSelect(selectElement, targetId) {
        const container = document.getElementById(targetId);
        if (container) {
            container.style.display = selectElement.value === 'card_set' ? 'block' : 'none';
        }
    }
</script>
{% endif %}

    <!-- Footer -->
    {% include 'includes/footer.html' %}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="{% static 'js/main.js' %}"></script>
</body>

</html>