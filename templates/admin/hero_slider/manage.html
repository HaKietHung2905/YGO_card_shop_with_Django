{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}Manage Hero Slider - Admin{% endblock %}

{% block content %}
<div class="content-header">
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0">
            <i class="fas fa-images me-2"></i>
            {{ page_title }}
        </h1>
        <div>
            <a href="{% url 'home' %}" class="btn btn-outline-primary me-2" target="_blank">
                <i class="fas fa-external-link-alt me-2"></i>View Homepage
            </a>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addSlideModal">
                <i class="fas fa-plus me-2"></i>Add New Slide
            </button>
        </div>
    </div>
</div>

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}

<div class="dashboard-card">
    <div class="mb-4">
        <p class="text-muted">
            <i class="fas fa-info-circle me-2"></i>
            Manage slider images: add new slides, edit existing ones, delete old ones, and reorder by changing the order
            number.
        </p>
    </div>

    {% if slides %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th style="width: 80px;">Order</th>
                    <th>Preview</th>
                    <th>Title</th>
                    <th>Link</th>
                    <th style="width: 100px;">Status</th>
                    <th style="width: 250px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for slide in slides %}
                <tr class="{% if not slide.is_active %}table-secondary{% endif %}">
                    <td>
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="reorder" value="1">
                            <input type="hidden" name="slide_id" value="{{ slide.id }}">
                            <input type="number" name="new_order" value="{{ slide.order }}"
                                class="form-control form-control-sm" style="width: 70px;" onchange="this.form.submit()">
                        </form>
                    </td>
                    <td>
                        <img src="{{ slide.image.url }}" alt="{{ slide.title }}" class="img-thumbnail"
                            style="max-width: 150px; max-height: 80px; object-fit: cover;">
                    </td>
                    <td>
                        <strong>{{ slide.title }}</strong>
                        {% if slide.description %}
                        <br><small class="text-muted">{{ slide.description|truncatewords:10 }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if slide.link_url %}
                        <small class="text-truncate d-block" style="max-width: 150px;">
                            {{ slide.link_url }}
                        </small>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="toggle_active" value="{{ slide.id }}">
                            <button type="submit"
                                class="btn btn-sm {% if slide.is_active %}btn-success{% else %}btn-secondary{% endif %}">
                                {% if slide.is_active %}
                                <i class="fas fa-check-circle me-1"></i>Active
                                {% else %}
                                <i class="fas fa-times-circle me-1"></i>Inactive
                                {% endif %}
                            </button>
                        </form>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary me-1" data-bs-toggle="modal"
                            data-bs-target="#editSlideModal{{ slide.id }}">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <form method="post" class="d-inline"
                            onsubmit="return confirm('Are you sure you want to delete this slide?');">
                            {% csrf_token %}
                            <input type="hidden" name="delete_slide" value="{{ slide.id }}">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        No slider images yet. Click "Add New Slide" to create your first slide!
    </div>
    {% endif %}
</div>

<!-- Edit Modals - ONLY ONE LOOP HERE -->
{% if slides %}
{% for slide in slides %}
<div class="modal fade" id="editSlideModal{{ slide.id }}" tabindex="-1"
    aria-labelledby="editSlideModalLabel{{ slide.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSlideModalLabel{{ slide.id }}">
                    <i class="fas fa-edit me-2"></i>Edit Slide: {{ slide.title }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="edit_slide" value="1">
                <input type="hidden" name="slide_id" value="{{ slide.id }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Current Image:</label>
                        <div class="mb-2">
                            <img src="{{ slide.image.url }}" alt="{{ slide.title }}" class="img-thumbnail"
                                style="max-width: 300px;">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_title_{{ slide.id }}" class="form-label fw-bold">Title *</label>
                        <input type="text" class="form-control" id="edit_title_{{ slide.id }}" name="title"
                            value="{{ slide.title }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit_description_{{ slide.id }}" class="form-label fw-bold">Description</label>
                        <textarea class="form-control" id="edit_description_{{ slide.id }}" name="description"
                            rows="2">{{ slide.description }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="edit_image_{{ slide.id }}" class="form-label fw-bold">Update Image</label>
                        <input type="file" class="form-control" id="edit_image_{{ slide.id }}" name="image"
                            accept="image/*">
                        <small class="form-text text-muted">Leave empty to keep current image</small>
                    </div>

                    <div class="mb-3">
                        <label for="edit_link_type_{{ slide.id }}" class="form-label fw-bold">Link To</label>
                        <select class="form-select" id="edit_link_type_{{ slide.id }}" name="link_type"
                            onchange="toggleCardSetSelect(this, 'edit_card_set_{{ slide.id }}')">
                            <option value="">-- No Link --</option>
                            <option value="all_cards" {% if slide.link_url == '/cards/' %}selected{% endif %}>
                                Tất cả thẻ bài
                            </option>
                            <option value="card_set" {% if '/cards/?set=' in slide.link_url and slide.link_url != '/cards/' %}selected{% endif %}>
                                Bộ thẻ bài cụ thể
                            </option>
                            <option value="other_products" {% if slide.link_url == '/other_products/' %}selected{% endif %}>
                                Sản phẩm khác
                            </option>
                        </select>
                    </div>

                    <div class="mb-3" id="edit_card_set_container_{{ slide.id }}"
                        style="display: {% if '/cards/?set=' in slide.link_url and slide.link_url != '/cards/' %}block{% else %}none{% endif %};">
                        <label for="edit_card_set_{{ slide.id }}" class="form-label fw-bold">Chọn bộ thẻ bài</label>
                        <select class="form-select" id="edit_card_set_{{ slide.id }}" name="card_set_id">
                            <option value="">-- Select Card Set --</option>
                            {% for card_set in card_sets %}
                            {% with expected_url='/cards/?set='|add:card_set.code %}
                            <option value="{{ card_set.id }}" {% if slide.link_url == expected_url %}selected{% endif %}>
                                {{ card_set.name }} ({{ card_set.code }})
                            </option>
                            {% endwith %}
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="edit_order_{{ slide.id }}" class="form-label fw-bold">Display Order</label>
                        <input type="number" class="form-control" id="edit_order_{{ slide.id }}" name="order"
                            value="{{ slide.order }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}

<!-- Add Slide Modal -->
<div class="modal fade" id="addSlideModal" tabindex="-1" aria-labelledby="addSlideModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSlideModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add New Slider Image
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="add_slide" value="1">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label fw-bold">Title *</label>
                        <input type="text" class="form-control" id="title" name="title" required
                            placeholder="e.g., New Card Set Release">
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label fw-bold">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2"
                            placeholder="Optional description for internal reference"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="image" class="form-label fw-bold">Image *</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*" required>
                        <small class="form-text text-muted">Recommended: 1200x400px or similar wide format</small>
                    </div>

                    <div class="mb-3">
                        <label for="link_type" class="form-label fw-bold">Link To</label>
                        <select class="form-select" id="link_type" name="link_type"
                            onchange="toggleCardSetSelect(this, 'card_set_id')">
                            <option value="">-- No Link --</option>
                            <option value="all_cards">Tất cả thẻ bài</option>
                            <option value="card_set">Bộ thẻ bài cụ thể</option>
                            <option value="other_products">Sản phẩm khác</option>
                        </select>
                        <small class="form-text text-muted">Where should this slide link to when clicked?</small>
                    </div>

                    <div class="mb-3" id="card_set_container" style="display: none;">
                        <label for="card_set_id" class="form-label fw-bold">Chọn bộ thẻ bài</label>
                        <select class="form-select" id="card_set_id" name="card_set_id">
                            <option value="">-- Select Card Set --</option>
                            {% for card_set in card_sets %}
                            <option value="{{ card_set.id }}">{{ card_set.name }} ({{ card_set.code }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="order" class="form-label fw-bold">Display Order</label>
                        <input type="number" class="form-control" id="order" name="order" value="0">
                        <small class="form-text text-muted">Lower numbers appear first (0, 1, 2, etc.)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Add Slide
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .dashboard-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        border: none;
    }

    .table tbody tr {
        transition: all 0.3s ease;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .img-thumbnail {
        border: 2px solid #ddd;
        border-radius: 8px;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
</style>

<script>
    function toggleCardSetSelect(selectElement, targetId) {
        const container = document.getElementById(targetId).closest('.mb-3');
        if (container) {
            container.style.display = selectElement.value === 'card_set' ? 'block' : 'none';
        }
    }
</script>
{% endblock %}